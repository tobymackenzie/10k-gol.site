#!/usr/bin/env php
<?php
$projectRoot = __DIR__ . '/..';

//--php
foreach(Array(
	'/'
	,'/dist/' //--for bc
	,'/info/'
	,'/project/'
) as $relDir){
	$dir = $projectRoot . $relDir;
	if(!is_dir($dir)){
		mkdir($dir, 0755, true);
	}
	$dest = $dir . 'index.php';
	file_put_contents(
		$dest
		, "<?php\nrequire(__DIR__ . '" . str_repeat('/..', substr_count($relDir, '/') - 1) . "/src/run/web.php');"
	);
}

//--scripts
chdir($projectRoot);
foreach(Array(
	Array(
		'src'=> $projectRoot . '/src/scripts/empty-cache.js'
		,'dest'=> $projectRoot . '/empty-cache.js'
	)
	,Array(
		'src'=> $projectRoot . '/src/scripts/main.js'
		,'dest'=> $projectRoot . '/main.js'
	)
	,Array(
		'src'=> $projectRoot . '/src/scripts/pre.js'
		,'dest'=> $projectRoot . '/pre.js'
	)
) as $data){
	$command = 'uglifyjs --compress --mangle -- ' . $data['src'] . ' > ' . $data['dest'];
	//-# may need for newer versions of uglify --support-ie8
	passthru($command);
}

//--styles
passthru('sass --sourcemap=none ' . $projectRoot . '/src/styles/builds/main.scss ' . $projectRoot . '/main.css');
