#!/usr/bin/env php
<?php
$projectRoot = __DIR__ . '/..';
chdir($projectRoot);

$commands = Array(
	'git checkout src'
	,'git push'
	,'git stash'
	,'git checkout dist'
	,'git rebase src'
	,'bin/build'
	,'{{commit}}'
	,'git push -f'
	,'git checkout master'
	,'git reset --hard HEAD~1'
	,'git rebase dist'
	,'git push -f'
	,'git checkout src'
	,'git stash pop'
);

$return = 0;
foreach($commands as $command){
	if($command === '{{commit}}'){
		passthru('git status');
		echo "Do you want to commit this dist?\n";
		$inputHandle = fopen("php://stdin","r");
		$input = fgets($inputHandle);
		switch(strtolower(trim($input))){
			case 'y':
			case 'yes':
				$command = 'git commit -a -m "build dist"';
			break;
			case 'a':
			case 'amend':
				$command = 'git commit -a --amend --no-edit';
			break;
			default:
				echo "cancelling";
				$return = 1;
			break;
		}
		fclose($inputHandle);
	}
	if($return === 0){
		echo "running {$command}\n";
		passthru($command, $return);
	}
}

